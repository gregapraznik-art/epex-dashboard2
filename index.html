<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EPEX SPOT — Strompreise</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600;700&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #080c14; --surface: rgba(0,200,150,0.04); --border: rgba(0,200,150,0.14);
      --green: #6bffb8; --green-dim: rgba(107,255,184,0.45); --red: #ff6b6b;
      --yellow: #ffd166; --purple: #a0a0ff; --text: #e0ffe8;
    }
    body { background: var(--bg); color: var(--text); font-family: 'IBM Plex Mono', monospace; min-height: 100vh; }
    header {
      border-bottom: 1px solid var(--border); padding: 18px 28px;
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(0,200,150,0.025);
    }
    .tag { font-size: 9px; color: var(--green); letter-spacing: 3px; text-transform: uppercase; }
    h1 { font-size: 19px; font-weight: 700; margin-top: 4px; }
    #last-update { font-size: 10px; color: var(--green-dim); text-align: right; line-height: 1.7; }
    main { padding: 22px 28px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 22px; }
    .btn-group { display: flex; gap: 4px; }
    .btn { padding: 6px 13px; font-size: 10px; font-family: inherit; border-radius: 4px; cursor: pointer; letter-spacing: 1px; transition: all 0.15s; background: transparent; }
    .btn-z  { border: 1px solid rgba(0,200,150,0.22); color: rgba(107,255,184,0.5); }
    .btn-z.on { border-color: rgba(0,200,150,0.6); background: rgba(0,200,150,0.16); color: var(--green); font-weight: 700; }
    .btn-i  { border: 1px solid rgba(107,107,255,0.22); color: rgba(160,160,255,0.5); }
    .btn-i.on { border-color: rgba(107,107,255,0.6); background: rgba(107,107,255,0.16); color: var(--purple); font-weight: 700; }
    .btn-r  { border: 1px solid rgba(0,200,150,0.3); color: var(--green); }
    .btn:hover { opacity: 0.75; }
    .auto-lbl { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--green-dim); cursor: pointer; letter-spacing: 1px; }
    .auto-lbl input { accent-color: var(--green); }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(148px,1fr)); gap: 12px; margin-bottom: 22px; }
    .kpi-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; }
    .kpi-lbl { font-size: 9px; color: rgba(107,255,184,0.4); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
    .kpi-val { font-size: 17px; font-weight: 700; color: var(--green); }
    .kpi-val.neg  { color: var(--red); }
    .kpi-val.warm { color: var(--yellow); }
    .kpi-val.dim  { color: rgba(107,255,184,0.25); }
    .chart-wrap {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 20px 12px 12px; margin-bottom: 18px; position: relative; min-height: 340px;
    }
    #chart-overlay {
      display: none; position: absolute; inset: 0; border-radius: 10px;
      background: rgba(8,12,20,0.88); align-items: center; justify-content: center;
      flex-direction: column; gap: 14px; z-index: 20; text-align: center; padding: 24px;
    }
    #chart-overlay.show { display: flex; }
    #ov-icon  { font-size: 28px; }
    #ov-msg   { font-size: 11px; color: var(--red); max-width: 420px; line-height: 1.6; }
    #ov-spin  { width: 28px; height: 28px; border-radius: 50%; border: 2px solid rgba(107,255,184,0.15); border-top-color: var(--green); animation: spin 0.8s linear infinite; }
    #ov-label { font-size: 10px; letter-spacing: 3px; color: rgba(107,255,184,0.5); }
    canvas { max-height: 300px; }
    .info { background: rgba(255,200,0,0.04); border: 1px solid rgba(255,200,0,0.14); border-radius: 8px; padding: 13px 18px; font-size: 10px; color: rgba(255,220,100,0.65); line-height: 1.8; }
    .info strong { color: rgba(255,220,100,0.9); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
    .dot.live { animation: pulse 2s infinite; }
    .dot.off  { background: #444; animation: none; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.35} }
    @keyframes spin  { to { transform: rotate(360deg); } }
    @media(max-width:600px) { header, main { padding-left:14px; padding-right:14px; } h1 { font-size:15px; } }
  </style>
</head>
<body>

<header>
  <div>
    <div style="display:flex;align-items:center;gap:9px">
      <div class="dot live" id="dot"></div>
      <span class="tag">EPEX SPOT</span>
    </div>
    <h1>Intraday Strompreise</h1>
  </div>
  <div id="last-update">–</div>
</header>

<main>
  <div class="controls">
    <div class="btn-group">
      <button class="btn btn-z on" data-z="DE-LU">DE/LU</button>
      <button class="btn btn-z" data-z="AT">AT</button>
      <button class="btn btn-z" data-z="FR">FR</button>
      <button class="btn btn-z" data-z="CH">CH</button>
      <button class="btn btn-z" data-z="BE">BE</button>
      <button class="btn btn-z" data-z="NL">NL</button>
    </div>
    <div class="btn-group">
      <button class="btn btn-i on" data-iv="day">Heute</button>
      <button class="btn btn-i" data-iv="week">Woche</button>
      <button class="btn btn-i" data-iv="month">Monat</button>
    </div>
    <button class="btn btn-r" id="reload">&#8635; Neu laden</button>
    <label class="auto-lbl">
      <input type="checkbox" id="auto-cb" checked> Auto (60s)
    </label>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card"><div class="kpi-lbl">Aktuell</div><div class="kpi-val dim" id="k-now">–</div></div>
    <div class="kpi-card"><div class="kpi-lbl">Minimum</div><div class="kpi-val dim" id="k-min">–</div></div>
    <div class="kpi-card"><div class="kpi-lbl">Maximum</div><div class="kpi-val dim" id="k-max">–</div></div>
    <div class="kpi-card"><div class="kpi-lbl">Durchschnitt</div><div class="kpi-val dim" id="k-avg">–</div></div>
    <div class="kpi-card"><div class="kpi-lbl">Negativ-Stunden</div><div class="kpi-val dim" id="k-neg">–</div></div>
  </div>

  <div class="chart-wrap">
    <div id="chart-overlay" class="show">
      <div id="ov-spin"></div>
      <div id="ov-label">LADEN...</div>
      <div id="ov-icon" style="display:none">&#9889;</div>
      <div id="ov-msg"></div>
      <button class="btn btn-r" id="ov-retry" style="display:none" onclick="loadData()">Erneut versuchen</button>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <div class="info">
    <strong>&#9432; Datenquelle:</strong> Fraunhofer ISE Energy-Charts API (api.energy-charts.info) —
    kostenlos, keine Registrierung. EPEX SPOT Day-Ahead Preise in &euro;/MWh, stündliche Auflösung.
  </div>
</main>

<script>
const API = "https://api.energy-charts.info/price";
let zone = "DE-LU", intv = "day", chart = null, timer = null;
const $ = id => document.getElementById(id);

function iso(d) { return d.toISOString().split(".")[0] + "Z"; }

function priceColor(v) {
  if (v == null) return "#6bffb8";
  if (v < 0)    return "#ff6b6b";
  if (v < 80)   return "#6bffb8";
  if (v < 150)  return "#ffd166";
  return "#ff6b6b";
}

function fmtP(v) { return v != null ? v.toFixed(2) + " €/MWh" : "–"; }

function fmtLabel(ts) {
  const d = new Date(ts * 1000);
  if (intv === "day") return d.toLocaleTimeString("de-AT", {hour:"2-digit", minute:"2-digit"});
  return d.toLocaleDateString("de-AT", {day:"2-digit", month:"2-digit"}) + " " +
         d.toLocaleTimeString("de-AT", {hour:"2-digit", minute:"2-digit"});
}

function showLoading() {
  $("ov-spin").style.display = "block";
  $("ov-label").style.display = "block";
  $("ov-icon").style.display = "none";
  $("ov-msg").textContent = "";
  $("ov-retry").style.display = "none";
  $("chart-overlay").classList.add("show");
}

function showError(msg) {
  $("ov-spin").style.display = "none";
  $("ov-label").style.display = "none";
  $("ov-icon").style.display = "block";
  $("ov-msg").textContent = msg;
  $("ov-retry").style.display = "inline-block";
  $("chart-overlay").classList.add("show");
}

function hideOverlay() { $("chart-overlay").classList.remove("show"); }

function setKPI(id, val, colorFn) {
  const el = $(id);
  el.textContent = val != null ? (id === "k-neg" ? val + "h" : fmtP(val)) : "–";
  el.className = "kpi-val";
  if (val != null) {
    const c = colorFn ? colorFn(val) : priceColor(val);
    if (c === "#ff6b6b") el.classList.add("neg");
    else if (c === "#ffd166") el.classList.add("warm");
  } else {
    el.classList.add("dim");
  }
}

async function loadData() {
  showLoading();
  const now = new Date();
  let start, end;
  if (intv === "day") {
    start = new Date(now); start.setHours(0,0,0,0);
    end   = new Date(now); end.setHours(23,59,59,0);
  } else if (intv === "week") {
    start = new Date(now); start.setDate(now.getDate()-6); start.setHours(0,0,0,0);
    end   = new Date(now);
  } else {
    start = new Date(now.getFullYear(), now.getMonth(), 1);
    end   = new Date(now);
  }

  const url = `${API}?bzn=${zone}&start=${iso(start)}&end=${iso(end)}`;

  try {
    const ctrl = new AbortController();
    const timeout = setTimeout(() => ctrl.abort(), 12000);
    const res = await fetch(url, { signal: ctrl.signal });
    clearTimeout(timeout);

    if (!res.ok) throw new Error("HTTP " + res.status + " — Zone möglicherweise nicht verfügbar");
    const json = await res.json();
    if (!json.unix_seconds || !json.price) throw new Error("Keine Preisdaten in der Antwort");

    const pts = json.unix_seconds
      .map((ts, i) => ({ ts, price: json.price[i], label: fmtLabel(ts) }))
      .filter(p => p.price != null);

    if (!pts.length) throw new Error("Keine Datenpunkte für diesen Zeitraum");

    renderChart(pts);

    const prices = pts.map(p => p.price);
    const last = prices[prices.length - 1];
    setKPI("k-now", last);
    setKPI("k-min", Math.min(...prices));
    setKPI("k-max", Math.max(...prices), v => v > 150 ? "#ff6b6b" : v > 80 ? "#ffd166" : "#6bffb8");
    setKPI("k-avg", prices.reduce((a,b) => a+b, 0) / prices.length);
    const neg = prices.filter(p => p < 0).length;
    const ne = $("k-neg"); ne.textContent = neg + "h";
    ne.className = "kpi-val" + (neg > 0 ? " neg" : "");

    $("last-update").innerHTML = "Aktualisiert<br>" + new Date().toLocaleTimeString("de-AT");
    hideOverlay();

  } catch(e) {
    showError(e.name === "AbortError" ? "Timeout (>12s) — API antwortet nicht" : e.message);
  }
}

function renderChart(pts) {
  const labels = pts.map(p => p.label);
  const prices = pts.map(p => p.price);
  const color  = priceColor(prices[prices.length - 1]);

  if (chart) { chart.destroy(); chart = null; }

  const ctx = $("chart").getContext("2d");
  const r = parseInt(color.slice(1,3),16), g = parseInt(color.slice(3,5),16), b = parseInt(color.slice(5,7),16);
  const grad = ctx.createLinearGradient(0, 0, 0, 280);
  grad.addColorStop(0, `rgba(${r},${g},${b},0.28)`);
  grad.addColorStop(1, `rgba(${r},${g},${b},0.02)`);

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        data: prices,
        borderColor: color, borderWidth: 2,
        backgroundColor: grad, fill: true,
        pointRadius: 0, pointHoverRadius: 5,
        pointHoverBackgroundColor: color,
        tension: 0.35,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 600, easing: "easeInOutQuart" },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: "rgba(6,10,18,0.97)",
          borderColor: `rgba(${r},${g},${b},0.4)`, borderWidth: 1,
          titleColor: `rgba(${r},${g},${b},0.7)`, bodyColor: color,
          titleFont: { family:"IBM Plex Mono", size:10 },
          bodyFont:  { family:"IBM Plex Mono", size:14, weight:"700" },
          padding: 10,
          callbacks: { label: c => "  " + c.parsed.y.toFixed(2) + " €/MWh" }
        }
      },
      scales: {
        x: {
          ticks: { color:"rgba(107,255,184,0.4)", font:{family:"IBM Plex Mono",size:9}, maxTicksLimit:12, maxRotation:0 },
          grid: { color:"rgba(107,255,184,0.06)" },
          border: { color:"rgba(107,255,184,0.15)" }
        },
        y: {
          ticks: { color:"rgba(107,255,184,0.4)", font:{family:"IBM Plex Mono",size:9}, callback: v => v + " €" },
          grid: { color:"rgba(107,255,184,0.06)" },
          border: { color:"transparent" }
        }
      }
    },
    plugins: [{
      id: "zeroLine",
      afterDraw(ch) {
        const ys = ch.scales.y;
        if (ys.min < 0 && ys.max > 0) {
          const y = ys.getPixelForValue(0), cx = ch.ctx;
          cx.save(); cx.beginPath(); cx.setLineDash([5,5]);
          cx.strokeStyle = "rgba(255,107,107,0.4)"; cx.lineWidth = 1;
          cx.moveTo(ch.chartArea.left, y); cx.lineTo(ch.chartArea.right, y);
          cx.stroke(); cx.restore();
        }
      }
    }]
  });
}

document.querySelectorAll(".btn-z").forEach(b => b.addEventListener("click", () => {
  document.querySelectorAll(".btn-z").forEach(x => x.classList.remove("on"));
  b.classList.add("on"); zone = b.dataset.z; loadData();
}));

document.querySelectorAll(".btn-i").forEach(b => b.addEventListener("click", () => {
  document.querySelectorAll(".btn-i").forEach(x => x.classList.remove("on"));
  b.classList.add("on"); intv = b.dataset.iv; loadData();
}));

$("reload").addEventListener("click", loadData);

$("auto-cb").addEventListener("change", e => {
  const dot = $("dot");
  if (e.target.checked) {
    dot.classList.add("live"); dot.classList.remove("off");
    timer = setInterval(loadData, 60000);
  } else {
    dot.classList.remove("live"); dot.classList.add("off");
    clearInterval(timer);
  }
});

timer = setInterval(loadData, 60000);
loadData();
</script>
</body>
</html>
